From 016f109f8220c32a55d7a4c21140c1312ff64bf9 Mon Sep 17 00:00:00 2001
From: thampan <joby.thampan@intel.com>
Date: Fri, 29 Jun 2018 16:24:59 +0800
Subject: [PATCH] DRVLIB_SW-778: Selection support for Enternal or Internal
 Reference Time in Xgmac

---
 drivers/net/ethernet/lantiq/switch-api/mac/gswss_api.c    |  0
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac.h        |  2 ++
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.c    | 15 +++++++++++++++
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.h    |  1 +
 .../net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c    | 15 +++++++++++++++
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c   |  7 +++++++
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c    |  4 ----
 7 files changed, 40 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/gswss_api.c b/drivers/net/ethernet/lantiq/switch-api/mac/gswss_api.c
old mode 100755
new mode 100644
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac.h b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac.h
index 4e4d72c919af..695562c14784 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac.h
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac.h
@@ -1025,6 +1025,8 @@ int xgmac_set_mac_lpitx(void *pdev, u32 val);
 int xgmac_pause_frame_filtering(void *pdev, u32 val);
 int xgmac_set_gint(void *pdev, u32 val);
 int xgmac_set_rxcrc(void *pdev, u32 val);
+void xgmac_set_exttime_source(void *pdev, u32 val);
+
 
 /* GET API's */
 int xgmac_get_hw_capability(void *pdev);
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.c b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.c
index f91de1a1ba2e..096a6c431a32 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.c
@@ -1007,6 +1007,21 @@ void cli_del_fifo(void *pdev)
 		fifo_entry_del(pdev, pdata->rec_id);
 	}
 }
+void cli_set_extsrc(void *pdev)
+{
+	u32 i = 0;
+	struct mac_prv_data *pdata = GET_MAC_PDATA(pdev);
+	struct mac_ops *ops;
+
+	if (pdata->set_all) {
+		for (i = 0; i < pdata->max_mac; i++) {
+			ops = gsw_get_mac_ops(0, i);
+			xgmac_set_exttime_source(ops, pdata->val);
+		}
+	} else {
+		xgmac_set_exttime_source(pdev, pdata->val);
+	}
+}
 
 void cli_test_all_reg(void *pdev)
 {
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.h b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.h
index 5e8c8e222fed..b3914e744e7a 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.h
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_cli.h
@@ -106,6 +106,7 @@ void cli_set_rxcrc(void *pdev);
 int cli_get_fifo(void *pdev);
 void cli_add_fifo(void *pdev);
 void cli_del_fifo(void *pdev);
+void cli_set_extsrc(void *pdev);
 
 #endif
 
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c
index c7368b81d817..6d57841056d6 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c
@@ -1669,6 +1669,21 @@ int xgmac_set_hwtstamp_settings(void *pdev,
 	return 0;
 }
 
+void xgmac_set_exttime_source(void *pdev, u32 val)
+{
+	struct mac_prv_data *pdata = GET_MAC_PDATA(pdev);
+	u32 reg_val;
+
+	reg_val = XGMAC_RGRD(pdata, MAC_TSTAMP_CR);
+
+	if (MAC_GET_VAL(reg_val, MAC_TSTAMP_CR, ESTI) != val) {
+		mac_printf("XGMAC %d: External Ref Time: %s\n",
+			   pdata->mac_idx,  val ? "ENABLED" : "DISABLED");
+		MAC_SET_VAL(reg_val, MAC_TSTAMP_CR, ESTI, val);
+		XGMAC_RGWR(pdata, MAC_TSTAMP_CR, reg_val);
+	}
+}
+
 void xgmac_ptp_txtstamp_mode(void *pdev,
 			     u32 snaptypesel,
 			     u32 tsmstrena,
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c
index a726d173260c..63d760d9ee40 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c
@@ -504,6 +504,13 @@ struct _xgmac_cfg xgmac_cfg_table[] = {
 		0, &pdata.rec_id, 0, 0, 0,
 		"<Del Tx Fifo>"
 	},
+	{
+		"ts_src_sel             ",
+		cli_set_extsrc,
+		0,
+		0, &pdata.val, 0, 0, 0,
+		"<REF: 0/1 - Internel/External>"
+	},
 	/* OTHERS */
 	{
 		"rmon            ",
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
old mode 100755
new mode 100644
index 2e308aef9fe4..2c0acb02e855
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
@@ -310,8 +310,6 @@ static void *parse_ptp_packet(struct sk_buff *skb,
 
 		*msg_type = *((u8 *)(ptp_loc + PTP_OFFS_MSG_TYPE)) & 0xf;
 
-		printk("Txing Message Type %d\n", *msg_type);
-
 		if ((*msg_type == PTP_MSGTYPE_SYNC) ||
 		    (*msg_type == PTP_MSGTYPE_DELREQ) ||
 		    (*msg_type == PTP_MSGTYPE_PDELREQ) ||
@@ -584,13 +582,11 @@ static int xgmac_extts_enable(struct ptp_clock_info *ptp,
 		case 0:
 			pdata->exts0_enabled = on ? 1 : 0;
 			XGMAC_RGWR_BITS(pdata, MAC_AUX_CTRL, ATSEN0, 1);
-			XGMAC_RGWR_BITS(pdata, MAC_TSTAMP_CR, ESTI, 1);
 			break;
 
 		case 1:
 			pdata->exts1_enabled = on ? 1 : 0;
 			XGMAC_RGWR_BITS(pdata, MAC_AUX_CTRL, ATSEN1, 1);
-			XGMAC_RGWR_BITS(pdata, MAC_TSTAMP_CR, ESTI, 1);
 			break;
 
 		default:
