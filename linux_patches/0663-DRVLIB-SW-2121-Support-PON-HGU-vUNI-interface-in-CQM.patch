From acaaf3a0f09876fdcc7de2efa09d7301eeb0a1f6 Mon Sep 17 00:00:00 2001
From: arathinx <ayyappanx.rathinam@intel.com>
Date: Wed, 15 May 2019 11:38:03 +0800
Subject: [PATCH] DRVLIB_SW-2121: Support PON HGU vUNI interface in CQM driver

---
 drivers/net/ethernet/lantiq/cqm/prx300/cqm.c        |  6 ++++++
 drivers/net/ethernet/lantiq/cqm/prx300/cqm.h        |  3 +++
 drivers/net/ethernet/lantiq/cqm/prx300/cqm_config.c | 10 ++++++++++
 3 files changed, 19 insertions(+)

diff --git a/drivers/net/ethernet/lantiq/cqm/prx300/cqm.c b/drivers/net/ethernet/lantiq/cqm/prx300/cqm.c
index b8e9dcc51da5..a65d8daa49b5 100644
--- a/drivers/net/ethernet/lantiq/cqm/prx300/cqm.c
+++ b/drivers/net/ethernet/lantiq/cqm/prx300/cqm.c
@@ -60,6 +60,7 @@ static struct tasklet_struct cbm_debug_tasklet;
 #define FLAG_LAN (DP_F_FAST_ETH_LAN | DP_F_GINT)
 #define FLAG_ACA (DP_F_FAST_WLAN | DP_F_FAST_DSL)
 #define FLAG_LSB_DONT_CARE 0x80000000
+#define FLAG_VUNI (DP_F_VUNI)
 
 struct cqm_egp_map epg_lookup_table[] = {
 	{0,	0,			0},
@@ -69,6 +70,7 @@ struct cqm_egp_map epg_lookup_table[] = {
 	{4,	CBM_PMAC_DYNAMIC,	FLAG_ACA},
 	{5,	CBM_PMAC_DYNAMIC,	FLAG_ACA},
 	{6,	CBM_PMAC_DYNAMIC,	FLAG_ACA},
+	{24,	CBM_PMAC_DYNAMIC,	FLAG_VUNI},
 };
 
 struct cqm_buf_dbg_cnt cqm_dbg_cntrs[CQM_MAX_POLICY_NUM][CQM_MAX_POOL_NUM];
@@ -95,6 +97,8 @@ int find_dqm_port_type(int port)
 		return DQM_DMA_TYPE;
 	else if ((port >= DQM_PON_START_ID) && (port <= DQM_PON_END_ID))
 		return DQM_PON_TYPE;
+	else if ((port >= DQM_VUNI_START_ID) && (port <= DQM_VUNI_END_ID))
+		return DQM_VUNI_TYPE;
 	else
 		return CBM_FAILURE;
 }
@@ -2482,6 +2486,7 @@ static s32 dp_enable(struct module *owner, u32 port_id,
 		}
 		break;
 	case DQM_DMA_TYPE:
+	case DQM_VUNI_TYPE:
 		break;
 	default:
 		dev_err(cqm_ctrl->dev, "Unknown port type %d\n", type);
@@ -3915,6 +3920,7 @@ static int configure_ports(const struct cqm_config *port_config)
 		switch (port_config->type) {
 		case DQM_DMA_TYPE:
 		case DQM_PON_TYPE:
+		case DQM_VUNI_TYPE:
 			result = conf_deq_dma_port(&port_config->data.dqm_dma);
 			break;
 		case DQM_CPU_TYPE:
diff --git a/drivers/net/ethernet/lantiq/cqm/prx300/cqm.h b/drivers/net/ethernet/lantiq/cqm/prx300/cqm.h
index 67a87f5ee841..bd84f1d20384 100644
--- a/drivers/net/ethernet/lantiq/cqm/prx300/cqm.h
+++ b/drivers/net/ethernet/lantiq/cqm/prx300/cqm.h
@@ -111,6 +111,8 @@ enum DQM_PORT_TYPE {
 	DQM_ACA_START_ID = 4,
 	DQM_ACA_END_ID = 6,
 	DQM_DMA_START_ID = 7,
+	DQM_VUNI_START_ID = 24,
+	DQM_VUNI_END_ID = 24,
 	DQM_DMA_END_ID = 22,
 	DQM_PON_START_ID = 26,
 	DQM_PON_END_ID = 89,
@@ -128,6 +130,7 @@ enum EQM_DQM_PORT_TYPE {
 	DQM_ACA_TYPE = 4,
 	DQM_DMA_TYPE = 7,
 	DQM_PON_TYPE = 26,
+	DQM_VUNI_TYPE = 27,
 	EQM_CPU_TYPE = 100,
 	EQM_DMA_TYPE = 200,
 	NONE_TYPE = 0xffff
diff --git a/drivers/net/ethernet/lantiq/cqm/prx300/cqm_config.c b/drivers/net/ethernet/lantiq/cqm/prx300/cqm_config.c
index 55659e373bcc..b2ace1524ba0 100644
--- a/drivers/net/ethernet/lantiq/cqm/prx300/cqm_config.c
+++ b/drivers/net/ethernet/lantiq/cqm/prx300/cqm_config.c
@@ -127,6 +127,16 @@ const struct cqm_config prx300_cqm_config[] = {
 	.data.dqm_dma.txpush_desc = 8,
 	},
 	{
+	.type = DQM_VUNI_TYPE,
+	.data.dqm_dma.port = 24,
+	.data.dqm_dma.port_range = 0,
+	.data.dqm_dma.dma_ctrl = 2,
+	.data.dqm_dma.dma_chan = 1,
+	.data.dqm_dma.port_enable = 1,
+	.data.dqm_dma.num_desc = 8,
+	.data.dqm_dma.txpush_desc = 8,
+	},
+	{
 	.type = DQM_DMA_TYPE,
 	.data.dqm_dma.port = DMA_PORT_FOR_FLUSH,
 	.data.dqm_dma.port_range = 0,
