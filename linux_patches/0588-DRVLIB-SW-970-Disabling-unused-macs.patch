From d9ab16020478299abf314df650e7dd947d7c0269 Mon Sep 17 00:00:00 2001
From: Dinesh Sudham <dineshx.sudham@intel.com>
Date: Fri, 10 May 2019 14:11:24 +0800
Subject: [PATCH] DRVLIB_SW-970: Disabling unused macs

---
 drivers/net/ethernet/lantiq/switch-api/gswip_dev/gsw_dev.c | 4 ++++
 drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.h       | 3 ---
 drivers/net/ethernet/lantiq/switch-api/mac/mac_drv.c       | 8 +++++++-
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h  | 2 ++
 4 files changed, 13 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/switch-api/gswip_dev/gsw_dev.c b/drivers/net/ethernet/lantiq/switch-api/gswip_dev/gsw_dev.c
index f740ee496524..9786d2e7df6f 100644
--- a/drivers/net/ethernet/lantiq/switch-api/gswip_dev/gsw_dev.c
+++ b/drivers/net/ethernet/lantiq/switch-api/gswip_dev/gsw_dev.c
@@ -239,6 +239,10 @@ static int gsw_add_macdev(struct gsw_cell *gsw_dev_cell, u32 devid)
 	/* Copy the initial values of MAC Private Data */
 	xgmac_init_pdata(mac_pdata, (int)gsw_dev[devid].mac_subdevs_cnt);
 
+	/* Get the status of mac node */
+	if (!of_device_is_available(gsw_dev_cell->of_node))
+		mac_pdata->mac_en = MAC_DIS;
+
 #ifdef CONFIG_OF
 	/* Retrieve the phymode */
 	ret = of_property_read_string(gsw_dev_cell->of_node, "phy-mode",
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.h b/drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.h
index b26ae76cd556..dd7d47760ebb 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.h
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.h
@@ -15,9 +15,6 @@
 #define RESET_OFF 	0
 #define RESET_ON 	1
 
-#define MAC_EN		1
-#define MAC_DIS		0
-
 /* MAC Interface API's */
 int mac_config_loopback(void *pdev, u32 loopback);
 int mac_config_ipg(void *pdev, u32 ipg);
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/mac_drv.c b/drivers/net/ethernet/lantiq/switch-api/mac/mac_drv.c
index a53eaa8075f6..d7056477e4f2 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/mac_drv.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/mac_drv.c
@@ -187,6 +187,12 @@ static int mac_probe(struct platform_device *pdev)
 	/* Init function fointers */
 	mac_init_fn_ptrs(&pdata->ops);
 
+	/* Disable unused MAC */
+	if (pdata->mac_en == MAC_DIS) {
+		mac_reset(&pdata->ops, RESET_OFF);
+		return 0;
+	}
+
 	/* Request IRQ for MAC */
 	mac_irq_init(pdata);
 
@@ -224,7 +230,7 @@ static int mac_probe(struct platform_device *pdev)
 		dp = "AUTO";
 
 	pr_debug("XGMAC Init %d: Speed: %s Link: %s Duplex: %s\n",
-		pdata->mac_idx, load, ls, dp);
+		 pdata->mac_idx, load, ls, dp);
 
 	return 0;
 }
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h
index e933b41c0900..94b989e74bbf 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h
@@ -112,6 +112,8 @@ extern int pc_uart_datawrite_32(u32 Offset, u32 value);
 
 #define UPTIME 0
 #define MAX_RETRY 2000
+#define MAC_EN		1
+#define MAC_DIS		0
 
 #if defined(PC_UTILITY) && PC_UTILITY
 #define NANOSEC_IN_ONESEC 550000
