From f733c83ddd9b3c0cb87bbb87d620b66c9fc99b12 Mon Sep 17 00:00:00 2001
From: Peter Harliman Liem <peter.harliman.liem@intel.com>
Date: Wed, 15 Aug 2018 15:18:20 +0800
Subject: [PATCH] DRVLIB_SW-876 - Add missing winbond nand flash configuration
 to ltq-spinand

---
 drivers/mtd/ltq-spinand/ltq_spinand.c | 18 ++++++++++++++++++
 drivers/mtd/nand/nand_ids.c           |  1 +
 include/linux/mtd/nand.h              |  1 +
 3 files changed, 20 insertions(+)

diff --git a/drivers/mtd/ltq-spinand/ltq_spinand.c b/drivers/mtd/ltq-spinand/ltq_spinand.c
index 96e398b5aa90..b199ff6e764a 100644
--- a/drivers/mtd/ltq-spinand/ltq_spinand.c
+++ b/drivers/mtd/ltq-spinand/ltq_spinand.c
@@ -294,6 +294,24 @@ static int spi_nand_manufacture_init(struct mtd_info *mtd, struct nand_chip *chi
 		}
 
 		break;
+
+	case NAND_MFR_WINBOND:
+		chip->ecc.strength = 1;
+		chip->ecc.size = 512;
+		chip->ecc.bytes = 8;
+
+		/* Winbond devices with 64-bytes OOB use 8th-byte OOB as ECC.
+		 * Therefore we move the BBT out of OOB to avoid conflict.
+		 * Refer to Winbond spec section 5, and also
+		 * initial comments on nand_bbt.c.
+		 */
+		chip->bbt_options |= NAND_BBT_NO_OOB;
+
+		/* no QE bit, set buffer mode */
+		config &= ~OTP_QE_BIT;
+		config |= OTP_BUF_MODE;
+		break;
+
 	default:
 		break;
 	}
diff --git a/drivers/mtd/nand/nand_ids.c b/drivers/mtd/nand/nand_ids.c
index 2af9869a115e..650868240b87 100644
--- a/drivers/mtd/nand/nand_ids.c
+++ b/drivers/mtd/nand/nand_ids.c
@@ -182,6 +182,7 @@ struct nand_manufacturers nand_manuf_ids[] = {
 	{NAND_MFR_SANDISK, "SanDisk"},
 	{NAND_MFR_INTEL, "Intel"},
 	{NAND_MFR_ATO, "ATO"},
+	{NAND_MFR_WINBOND, "Winbond"},
 	{0x0, "Unknown"}
 };
 
diff --git a/include/linux/mtd/nand.h b/include/linux/mtd/nand.h
index 07c95bf873c8..75f4b0ff17e5 100644
--- a/include/linux/mtd/nand.h
+++ b/include/linux/mtd/nand.h
@@ -929,6 +929,7 @@ static inline void nand_set_controller_data(struct nand_chip *chip, void *priv)
 #define NAND_MFR_SANDISK	0x45
 #define NAND_MFR_INTEL		0x89
 #define NAND_MFR_ATO		0x9b
+#define NAND_MFR_WINBOND	0xef
 
 /* The maximum expected count of bytes in the NAND ID sequence */
 #define NAND_MAX_ID_LEN 8
