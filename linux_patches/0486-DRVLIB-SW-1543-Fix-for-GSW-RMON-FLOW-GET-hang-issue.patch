From 4f8c076154246f05b84040ece0982aa1bd0b8f53 Mon Sep 17 00:00:00 2001
From: Dinesh Sudham <dineshx.sudham@intel.com>
Date: Mon, 25 Feb 2019 18:37:00 +0800
Subject: [PATCH] DRVLIB_SW-1543: Fix for GSW_RMON_FLOW_GET hang issue

---
 drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c b/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c
index fc996818ed24..842da3fdc3c2 100644
--- a/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c
+++ b/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c
@@ -25762,10 +25762,6 @@ GSW_return_t GSW_RMON_FlowGet(void *cdev, GSW_RMON_flowGet_t *parm)
 		return GSW_statusErr;
 	}
 
-#ifdef __KERNEL__
-	spin_lock_bh(&gswdev->lock_bm);
-#endif
-
 	//Given absolute couter index to read.
 	if (parm->bIndex)
 		tflowIndex = parm->nIndex;
@@ -25792,16 +25788,20 @@ GSW_return_t GSW_RMON_FlowGet(void *cdev, GSW_RMON_flowGet_t *parm)
 			pr_err("ERR:nPortId's MS %d bits are not matching the group %d\n",
 			       (9 - (nBits - 1)), cMode.nPortMsb);
 			ret = GSW_statusErr;
-			goto UNLOCK_AND_RETURN;
+			return ret;
 		}
 	}
 
 	//Validate absolute couter index.
 	if (tflowIndex >= PCE_TABLE_SIZE) { //Max index check.
 		ret = GSW_statusErr;
-		goto UNLOCK_AND_RETURN;
+		return ret;
 	}
 
+#ifdef __KERNEL__
+	spin_lock_bh(&gswdev->lock_bm);
+#endif
+
 	//1.Get PCE Rx counters.
 	portType = GSW_RMON_TFLOW_RX;
 	//Populate 'data' register's Port-Offset.
