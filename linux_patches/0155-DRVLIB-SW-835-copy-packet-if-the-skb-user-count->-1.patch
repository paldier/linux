From 5463ad4bf847fa7e460e83c8c161c89d8c70e2dc Mon Sep 17 00:00:00 2001
From: kavitha3 <k.subramanian@intel.com>
Date: Fri, 13 Jul 2018 16:35:16 +0800
Subject: [PATCH] DRVLIB_SW-835:copy packet if the skb user count > 1

---
 drivers/net/ethernet/lantiq/cqm/falconmx/cqm.c | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/cqm/falconmx/cqm.c b/drivers/net/ethernet/lantiq/cqm/falconmx/cqm.c
index 29c0de399417..61d199d3375f 100644
--- a/drivers/net/ethernet/lantiq/cqm/falconmx/cqm.c
+++ b/drivers/net/ethernet/lantiq/cqm/falconmx/cqm.c
@@ -1670,7 +1670,7 @@ static s32 cqm_cpu_pkt_tx(struct sk_buff *skb, struct cbm_tx_data *data,
 	u32 tmp_data_ptr;
 	struct dma_tx_desc_2 *desc_2 = (struct dma_tx_desc_2 *)&skb->DW2;
 	u32 new_buf = 0;
-	s32 clone_f, no_hdr_room_f = 0;
+	s32 clone_f, shared_f, no_hdr_room_f = 0;
 	int pool, policy, tot_len, buf_size, cpu_buf;
 	int copied_to_cbm = 0;
 	void *metadata;
@@ -1678,13 +1678,14 @@ static s32 cqm_cpu_pkt_tx(struct sk_buff *skb, struct cbm_tx_data *data,
 	dev_dbg(cqm_ctrl->dev, "%s\n", __func__);
 	tot_len = skb->len;
 	clone_f = skb_cloned(skb);
+	shared_f = skb_shared(skb);
 	cpu_buf = !check_ptr_validation_falconmx((u32)(skb->head));
 
 	if (data && data->pmac) {
 		no_hdr_room_f = skb_headroom(skb) < data->pmac_len ? 1 : 0;
 		tot_len = skb->len + data->pmac_len;
 	}
-	if (cpu_buf || clone_f || no_hdr_room_f) {
+	if (cpu_buf || clone_f || no_hdr_room_f || shared_f) {
 		dev_dbg(cqm_ctrl->dev, "linearising\n");
 		new_buf = (u32)cqm_buffer_alloc(smp_processor_id(), 0,
 						tot_len, &buf_size);
@@ -1735,8 +1736,7 @@ static s32 cqm_cpu_pkt_tx(struct sk_buff *skb, struct cbm_tx_data *data,
 		cqm_buffer_free(smp_processor_id(), (void *)tmp_data_ptr, 1);
 		goto ERR_CASE_2;
 	}
-	if (copied_to_cbm)
-		dev_kfree_skb_any(skb);
+	dev_kfree_skb_any(skb);
 
 	if (cqm_cpu_enqueue(smp_processor_id(), &desc)) {
 		dev_err(cqm_ctrl->dev, "cpu enqueue failed..\n");
