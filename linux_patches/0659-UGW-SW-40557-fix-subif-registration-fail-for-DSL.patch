From 220e7bab1cda6b4f82672d0fd7d2db55edd120a0 Mon Sep 17 00:00:00 2001
From: Rekha Eswaran <rekha.eswaran@intel.com>
Date: Wed, 26 Jun 2019 17:36:42 +0800
Subject: [PATCH] UGW_SW-40557 - fix subif registration fail for DSL

---
 drivers/net/datapath/dpm/datapath_misc.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/net/datapath/dpm/datapath_misc.c b/drivers/net/datapath/dpm/datapath_misc.c
index 5a6a0cbd0989..6ace2ffc1230 100644
--- a/drivers/net/datapath/dpm/datapath_misc.c
+++ b/drivers/net/datapath/dpm/datapath_misc.c
@@ -1309,13 +1309,16 @@ int32_t dp_sync_subifid(struct net_device *dev, char *subif_name,
 			u32 flags, int *f_subif_up)
 {
 	void *subif_data = NULL;
+	struct pmac_port_info *port;
+
 	/* Note: workaround to set dummy subif_data via subif_name for DSL case.
 	 *       During dp_get_netif_subifID, subif_data is used to get its PVC
 	 *       information.
 	 * Later VRX518/618 need to provide valid subif_data in order to support
 	 * multiple DSL instances during dp_register_subif_ext
 	 */
-	if (flags & DP_F_FAST_DSL)
+	port = get_dp_port_info(0, subif_id->port_id);
+	if (port->alloc_flags & DP_F_FAST_DSL)
 		subif_data = (void *)subif_name;
 	/*check flag for register / deregister to update/del */
 	if (flags & DP_F_DEREGISTER) {
@@ -1348,6 +1351,7 @@ int32_t dp_sync_subifid_priv(struct net_device *dev, char *subif_name,
 			     int *f_subif_up)
 {
 	void *subif_data = NULL;
+	struct pmac_port_info *port;
 
 	/* Note: workaround to set dummy subif_data via subif_name for DSL case.
 	 *       During dp_get_netif_subifID, subif_data is used to get its PVC
@@ -1355,7 +1359,8 @@ int32_t dp_sync_subifid_priv(struct net_device *dev, char *subif_name,
 	 * Later VRX518/618 need to provide valid subif_data in order to support
 	 * multiple DSL instances during dp_register_subif_ext
 	 */
-	if (flags & DP_F_FAST_DSL)
+	port = get_dp_port_info(0, subif_id->port_id);
+	if (port->alloc_flags & DP_F_FAST_DSL)
 		subif_data = (void *)subif_name;
 	/*check flag for register / deregister to update/del */
 	if (flags & DP_F_DEREGISTER) {
