From b4d50a8e0ceda13ffa649e1787b9675eabbe811b Mon Sep 17 00:00:00 2001
From: pungavan <ramesh.pungavanam@intel.com>
Date: Wed, 27 Mar 2019 12:31:25 +0530
Subject: [PATCH] UGW_SW-36932 icc driver uapi adaptations

---
 drivers/char/ltq_icc/drv_icc.c                     |  2 +-
 drivers/char/ltq_icc/drv_icc_user.h                | 69 ----------------------
 drivers/char/ltq_icc/icc_client.c                  |  2 +-
 drivers/char/ltq_icc/proc_redirect.c               |  2 +-
 drivers/char/ltq_icc/proc_redirect_bootcore.c      |  2 +-
 drivers/char/ltq_mps2/drv_mps_common.c             |  2 +-
 drivers/char/ltq_mps2/drv_mps_linux.c              |  2 +-
 drivers/char/ltq_reset/ltq_system_reset.c          |  4 +-
 include/uapi/linux/Kbuild                          |  1 +
 include/uapi/linux/icc/Kbuild                      |  3 +
 .../ltq_icc => include/uapi/linux/icc}/drv_icc.h   | 10 ++--
 .../ltq_mps2 => include/uapi/linux/icc}/drv_mps.h  |  0
 12 files changed, 16 insertions(+), 83 deletions(-)

diff --git a/drivers/char/ltq_icc/drv_icc.c b/drivers/char/ltq_icc/drv_icc.c
index 7fb5ea3e8b95..8040db153f8b 100644
--- a/drivers/char/ltq_icc/drv_icc.c
+++ b/drivers/char/ltq_icc/drv_icc.c
@@ -55,7 +55,7 @@
 #include <asm/unistd.h>
 #include <asm/cacheflush.h>     // flush_cache_range
 /*icc header file*/
-#include "drv_icc.h"
+#include <linux/icc/drv_icc.h>
 /****************************Local definitions**************************/
 #define FIFO_GET_READ_PTR(index)  (ICC_BUFFER[index].fifo_read)
 #define FIFO_GET_WRITE_PTR(index) (ICC_BUFFER[index].fifo_write)
diff --git a/drivers/char/ltq_icc/drv_icc_user.h b/drivers/char/ltq_icc/drv_icc_user.h
deleted file mode 100644
index a2a405ef8df9..000000000000
--- a/drivers/char/ltq_icc/drv_icc_user.h
+++ /dev/null
@@ -1,69 +0,0 @@
-#ifndef _DRV_ICC_USER_H
-#define _DRV_ICC_USER_H
-/******************************************************************************
-
-                              Copyright (c) 2012
-                            Lantiq Deutschland GmbH
-                             http://www.lantiq.com
-
-  For licensing information, see the file 'LICENSE' in the root folder of
-  this software module.
-
-****************************************************************************
-   Module      : drv_icc_user.h
-   Description : This file contains the defines, the structures declarations
-                 the tables declarations and the global functions declarations.
-*******************************************************************************/
-/* ============================= */
-/* ICC Common defines            */
-/* ============================= */
-/*---------------------------------------------------------------------------*/
-
-#define MAX_UPSTRM_DATAWORDS 4
-#define ICC_PARAM_PTR 0x1
-#define ICC_PARAM_NO_PTR 0x0
-#define ICC_PARAM_PTR_IOCU 0x1
-#define ICC_PARAM_PTR_NON_IOCU 0x0
-#define CHECK_PTR(Attrs,Index) (Attrs&(ICC_PARAM_PTR<<(Index*2)))
-#define CHECK_PTR_IOCU(Attrs,Index) (Attrs&(ICC_PARAM_PTR_IOCU<<((Index*2)+1)))
-#define SET_PTR(Attrs,Index) (Attrs|(ICC_PARAM_PTR<<(Index*2)))
-#define SET_PTR_IOCU(Attrs,Index) (Attrs|(ICC_PARAM_PTR_IOCU<<((Index*2)+1)))
-#define CONVERT_KERNEL_TO_PHYADDR(addr) (addr&0x7FFFFFFF)
-/*---------------------------------------------------------------------------*/
-/* Device connection structure                                               */
-/*---------------------------------------------------------------------------*/
-typedef struct{
- uint8_t src_client_id;
- uint8_t dst_client_id;
- uint8_t msg_id;
- uint8_t param_attr;
- uint32_t param[MAX_UPSTRM_DATAWORDS];
-} icc_msg_t;
-
-typedef struct{
-	uint32_t address[MAX_UPSTRM_DATAWORDS];
-  uint32_t length[MAX_UPSTRM_DATAWORDS];
-  uint32_t offset[MAX_UPSTRM_DATAWORDS];
-	uint32_t count;
-}icc_commit_t;
-
-/*Always keep your new clients within InvalidClient and MAX_CLIENT*/
-typedef enum
-{
-   ICC_Client,/*Icc client Id*/
-	 IA,/*Image authenticator*/
-	 SR,/*System reset driver*/
-	 IR,/*Ioctl redirector*/
-	 PR,/*procfs redirector*/
-   MAX_CLIENT=21/*MAX_CLIENT_ID*/
-} icc_devices;/*enum for all the possible clients*/
-/******************************************************************************
- * Exported functions
- ******************************************************************************/
-/** magic number */
-#define ICC_MAGIC 'S'
-#define ICC_IOC_REG_CLIENT _IOW(ICC_MAGIC,1,uint32_t)
-#define ICC_IOC_MEM_COMMIT _IOW(ICC_MAGIC,2,icc_commit_t)
-#define ICC_IOC_MEM_INVALIDATE _IOW(ICC_MAGIC,3,icc_commit_t)
-
-#endif /* _DRV_ICC_USER_H */
diff --git a/drivers/char/ltq_icc/icc_client.c b/drivers/char/ltq_icc/icc_client.c
index 39c0d211656d..092cf9c397f4 100644
--- a/drivers/char/ltq_icc/icc_client.c
+++ b/drivers/char/ltq_icc/icc_client.c
@@ -29,7 +29,7 @@
 #include <linux/module.h>
 #include <linux/sched.h>
 #include <linux/slab.h>
-#include "drv_icc.h"
+#include <linux/icc/drv_icc.h>
 
 extern uint32_t BLOCK_MSG[MAX_CLIENT];
 extern void process_icc_message(unsigned int uiClientId);
diff --git a/drivers/char/ltq_icc/proc_redirect.c b/drivers/char/ltq_icc/proc_redirect.c
index 688c5672fa81..1849464ecbb7 100644
--- a/drivers/char/ltq_icc/proc_redirect.c
+++ b/drivers/char/ltq_icc/proc_redirect.c
@@ -29,7 +29,7 @@
 #include <linux/module.h>
 #include <linux/sched.h>
 #include <linux/slab.h>
-#include "drv_icc.h"
+#include <linux/icc/drv_icc.h>
 
 #ifdef CONFIG_PROC_FS
 #include <internal.h>
diff --git a/drivers/char/ltq_icc/proc_redirect_bootcore.c b/drivers/char/ltq_icc/proc_redirect_bootcore.c
index 6064b487b7bd..a1cddce7c217 100644
--- a/drivers/char/ltq_icc/proc_redirect_bootcore.c
+++ b/drivers/char/ltq_icc/proc_redirect_bootcore.c
@@ -36,7 +36,7 @@
 #include <asm/uaccess.h>
 #include <linux/buffer_head.h>
 
-#include "drv_icc.h"
+#include <linux/icc/drv_icc.h>
 
 extern struct proc_dir_entry *proc_lokup_dir;
 struct proc_dir_entry *bootcore_proc_dir;
diff --git a/drivers/char/ltq_mps2/drv_mps_common.c b/drivers/char/ltq_mps2/drv_mps_common.c
index 2267fdfe7c75..fdc12ed28307 100644
--- a/drivers/char/ltq_mps2/drv_mps_common.c
+++ b/drivers/char/ltq_mps2/drv_mps_common.c
@@ -26,7 +26,7 @@
 #include <linux/slab.h>
 #include <linux/wait.h>
 #include <linux/sched.h>
-#include "drv_mps.h"
+#include <linux/icc/drv_mps.h>
 #include "drv_mps_dbg.h"
 #include "drv_mps_device.h"
 
diff --git a/drivers/char/ltq_mps2/drv_mps_linux.c b/drivers/char/ltq_mps2/drv_mps_linux.c
index 321fca4225c1..1bb39a9ee4c5 100644
--- a/drivers/char/ltq_mps2/drv_mps_linux.c
+++ b/drivers/char/ltq_mps2/drv_mps_linux.c
@@ -60,7 +60,7 @@
 #include <grx500_bootcore_time.h>
 #include <grx500_bootcore_interrupt.h>
 #endif
-#include "drv_mps.h"
+#include <linux/icc/drv_mps.h>
 #include "drv_mps_dbg.h"
 #include "drv_mps_device.h"
 /* device structure */
diff --git a/drivers/char/ltq_reset/ltq_system_reset.c b/drivers/char/ltq_reset/ltq_system_reset.c
index b35a89e150de..b1e8ed5f7284 100644
--- a/drivers/char/ltq_reset/ltq_system_reset.c
+++ b/drivers/char/ltq_reset/ltq_system_reset.c
@@ -61,8 +61,8 @@
 #include "../../../arch/mips/lantiq/grx500_bootcore/ngi_map.h"
 #endif /* SUPPORT_NGI_DRIVER */
 #ifdef SUPPORT_ICC_DRIVER
-#include "../ltq_mps2/drv_mps.h"
-#include "../ltq_icc/drv_icc.h"
+#include <linux/icc/drv_mps.h>
+#include <linux/icc/drv_icc.h>
 #endif /* SUPPORT_ICC_DRIVER */
 
 #include <linux/ltq_system_reset.h>
diff --git a/include/uapi/linux/Kbuild b/include/uapi/linux/Kbuild
index cd2be1c8e9fb..777a082eddaf 100644
--- a/include/uapi/linux/Kbuild
+++ b/include/uapi/linux/Kbuild
@@ -22,6 +22,7 @@ header-y += netfilter_ipv4/
 header-y += netfilter_ipv6/
 header-y += usb/
 header-y += wimax/
+header-y += icc/
 
 genhdr-y += version.h
 
diff --git a/include/uapi/linux/icc/Kbuild b/include/uapi/linux/icc/Kbuild
new file mode 100644
index 000000000000..44cd44b54f22
--- /dev/null
+++ b/include/uapi/linux/icc/Kbuild
@@ -0,0 +1,3 @@
+# UAPI Header export list
+header-y += drv_icc.h
+header-y += drv_mps.h
diff --git a/drivers/char/ltq_icc/drv_icc.h b/include/uapi/linux/icc/drv_icc.h
similarity index 95%
rename from drivers/char/ltq_icc/drv_icc.h
rename to include/uapi/linux/icc/drv_icc.h
index 216295f91a6a..9b8d7d4e3d34 100644
--- a/drivers/char/ltq_icc/drv_icc.h
+++ b/include/uapi/linux/icc/drv_icc.h
@@ -1,5 +1,5 @@
-#ifndef _DRV_ICC_H
-#define _DRV_ICC_H
+#ifndef _DRV_UAPI_ICC_H
+#define _DRV_UAPI_ICC_H
 /******************************************************************************
 
                               Copyright (c) 2012
@@ -14,9 +14,7 @@
    Description : This file contains the defines, the structures declarations
                  the tables declarations and the global functions declarations.
 *******************************************************************************/
-#include <linux/fs.h>
-#include "../ltq_mps2/drv_config.h"
-#include "../ltq_mps2/drv_mps.h"
+#include "drv_mps.h"
 /* ============================= */
 /* ICC Common defines            */
 /* ============================= */
@@ -115,4 +113,4 @@ int icc_init(void);
 int icc_raw_read (icc_msg_t * rw);
 int icc_write (icc_devices type, icc_msg_t * rw);
 #endif
-#endif /* _DRV_ICC_H */
+#endif /* _DRV_UAPI_ICC_H */
diff --git a/drivers/char/ltq_mps2/drv_mps.h b/include/uapi/linux/icc/drv_mps.h
similarity index 100%
rename from drivers/char/ltq_mps2/drv_mps.h
rename to include/uapi/linux/icc/drv_mps.h
