From ae30265ba7317a385f8ac1658f593cc83564e135 Mon Sep 17 00:00:00 2001
From: Oren Bakshe <oren.bakshe@intel.com>
Date: Wed, 20 Mar 2019 01:39:02 +0200
Subject: [PATCH] PONRTSYS-3665: Increased the command buffer and the size of
 moved nodes array

---
 drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_fw.c    | 11 ++++++++---
 drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_linux.c |  6 +++---
 2 files changed, 11 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_fw.c b/drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_fw.c
index dbfc37e112ad..22f159fd927d 100644
--- a/drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_fw.c
+++ b/drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_fw.c
@@ -96,7 +96,7 @@ struct ppv4_qos_fw_hdr {
 #define FW_OK_SIGN			(0xCAFECAFEU)
 #define QOS_ELF_MAX_SECS		(64)
 #define FW_DCCM_START			(0xF0000000)
-#define FW_CMD_BUFFER_DCCM_START	(FW_DCCM_START + 0x6000)
+#define FW_CMD_BUFFER_DCCM_START	(FW_DCCM_START + 0x4000)
 
 static void copy_section(void *_dst, const void *_src, unsigned int size)
 {
@@ -1347,7 +1347,7 @@ struct fw_internal {
 	unsigned int moved_node_index;
 	struct move_info {
 		unsigned int phy;
-	} moved_nodes[2 * MAX_MOVING_NODES];
+	} moved_nodes[16 * MAX_MOVING_NODES];
 	unsigned int	pushed;
 	int		ongoing;
 };
@@ -1409,7 +1409,7 @@ static void update_moved_nodes(
 	}
 
 	internals->moved_node_index = j;
-	QOS_ASSERT(internals->moved_node_index < 2 * MAX_MOVING_NODES,
+	QOS_ASSERT(internals->moved_node_index < 16 * MAX_MOVING_NODES,
 			"Moved ports buffer is full\n");
 	if (!found) {
 		internals->moved_nodes[j].phy = dst;
@@ -3078,6 +3078,11 @@ void enqueue_cmds(struct pp_qos_dev *qdev)
 		flags = qos_u32_from_uc(*prev);
 		QOS_BITS_SET(flags, UC_CMD_FLAG_MULTIPLE_COMMAND_LAST);
 		*prev = qos_u32_to_uc(flags);
+
+		/* Read start & end of command buffer to avoid race with FW */
+		qos_u32_from_uc(*(volatile uint32_t *)start);
+		qos_u32_from_uc(*(volatile uint32_t *)cur);
+
 		signal_uc(qdev);
 	}
 }
diff --git a/drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_linux.c b/drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_linux.c
index f6ed20c54c7f..fac51cc05535 100644
--- a/drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_linux.c
+++ b/drivers/net/ethernet/lantiq/ppv4/qos/pp_qos_linux.c
@@ -47,9 +47,9 @@
  */
 struct device *cur_dev;
 
-#define PPV4_QOS_CMD_BUF_SIZE (0x1000)
-#define PPV4_QOS_CMD_BUF_OFFSET (0x6000U)
-#define MAX_CMD_SIZE 150
+#define PPV4_QOS_CMD_BUF_SIZE (0x4000)
+#define PPV4_QOS_CMD_BUF_OFFSET (0x4000U)
+#define MAX_CMD_SIZE 200
 
 void stop_run(void)
 {
