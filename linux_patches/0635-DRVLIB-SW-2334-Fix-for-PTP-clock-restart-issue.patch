From baef821a1c9ecb59318700d28ac6df5b59d0ab0f Mon Sep 17 00:00:00 2001
From: Dinesh Sudham <dineshx.sudham@intel.com>
Date: Wed, 12 Jun 2019 10:07:14 +0800
Subject: [PATCH] DRVLIB_SW-2334: Fix for PTP clock restart issue

---
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c | 2 +-
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c     | 9 ++++++++-
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.h     | 2 +-
 3 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c
index 96abd77a03d9..dabf1f430b2f 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_mac_api.c
@@ -1649,7 +1649,7 @@ int xgmac_set_hwtstamp_settings(void *pdev,
 	xgmac_config_tstamp(pdev, mac_tscr);
 
 #ifdef __KERNEL__
-	xgmac_config_timer_reg(pdev);
+	xgmac_config_timer_reg(pdev, mac_tscr);
 #endif
 
 	return 0;
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
index 9d93a56368c6..4f8c07bc9579 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
@@ -61,7 +61,7 @@ static int xgmac_ptp_register(void *pdev);
 static void xgmac_extts_isr_handler(struct mac_prv_data *pdata,
 				    u32 tstamp_sts);
 
-void xgmac_config_timer_reg(void *pdev)
+int xgmac_config_timer_reg(void *pdev, u32 mac_tscr)
 {
 	struct mac_prv_data *pdata = GET_MAC_PDATA(pdev);
 	struct timespec now;
@@ -69,6 +69,11 @@ void xgmac_config_timer_reg(void *pdev)
 	u64 temp = 0;
 
 	if (!pdata->systime_initialized) {
+		/* Check Timestamp Enabled/Disabled
+		 * Exit if Disabled, No need to Intialize the Timer
+		 */
+		if (!MAC_GET_VAL(mac_tscr, MAC_TSTAMP_CR, TSENA))
+			return 0;
 
 		/* program Sub Second Increment Reg */
 		hw_if->config_subsec_inc(pdev, pdata->ptp_clk);
@@ -87,6 +92,8 @@ void xgmac_config_timer_reg(void *pdev)
 		hw_if->init_systime(pdev, now.tv_sec, now.tv_nsec);
 		pdata->systime_initialized = 1;
 	}
+
+	return 0;
 }
 
 /* API to adjust the frequency of hardware clock.
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.h b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.h
index 8a873afa311b..4b6a3eef5c8c 100644
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.h
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.h
@@ -84,7 +84,7 @@ int xgmac_set_hwts(void *pdev, struct ifreq *ifr);
 int xgmac_get_hwts(void *pdev, struct ifreq *ifr);
 int xgmac_ptp_init(void *pdev);
 void xgmac_ptp_remove(void *pdev);
-void xgmac_config_timer_reg(void *pdev);
+int xgmac_config_timer_reg(void *pdev, u32 mac_tscr);
 int xgmac_ptp_tx_work(struct work_struct *work);
 int xgmac_get_ts_info(void *pdev,
 		      struct ethtool_ts_info *ts_info);
