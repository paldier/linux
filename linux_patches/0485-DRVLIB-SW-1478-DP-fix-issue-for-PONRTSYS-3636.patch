From fb6a86dc9a2f85e7d9276048b81d4285f941825c Mon Sep 17 00:00:00 2001
From: Rekha Eswaran <rekha.eswaran@intel.com>
Date: Fri, 22 Feb 2019 15:56:46 +0800
Subject: [PATCH] DRVLIB_SW-1478: DP fix issue for PONRTSYS-3636

---
 drivers/net/ethernet/lantiq/datapath/datapath_api.c      | 11 +++++++++--
 drivers/net/ethernet/lantiq/datapath/datapath_proc_qos.c |  2 +-
 2 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/datapath/datapath_api.c b/drivers/net/ethernet/lantiq/datapath/datapath_api.c
index b97a530d31e1..4522e1dd8258 100644
--- a/drivers/net/ethernet/lantiq/datapath/datapath_api.c
+++ b/drivers/net/ethernet/lantiq/datapath/datapath_api.c
@@ -47,7 +47,7 @@ struct dma_rx_desc_1 dma_tx_desc_mask1;
 u32 dp_drop_all_tcp_err;
 u32 dp_pkt_size_check;
 
-u32 dp_dbg_flag=DP_DBG_FLAG_DBG|DP_DBG_FLAG_REG;
+u32 dp_dbg_flag;
 EXPORT_SYMBOL(dp_dbg_flag);
 
 #ifdef CONFIG_LTQ_DATAPATH_MPE_FASTHOOK_TEST
@@ -697,6 +697,8 @@ int32_t dp_deregister_subif_private(int inst, struct module *owner,
 	struct pmac_port_info *port_info;
 	struct cbm_dp_en_data cbm_data = {0};
 	struct subif_platform_data platfrm_data = {0};
+	u32 dma_chan;
+	u32 cid, pid, nid;
 
 	port_id = subif_id->port_id;
 	port_info = &dp_port_info[inst][port_id];
@@ -771,8 +773,13 @@ int32_t dp_deregister_subif_private(int inst, struct module *owner,
 		cbm_data.dp_inst = inst;
 		cbm_data.cbm_inst = dp_port_prop[inst].cbm_inst;
 		cbm_data.deq_port = cqm_port;
+		dma_chan = dp_deq_port_tbl[inst][cqm_port].dma_chan;
+		cid = _DMA_CONTROLLER(dma_chan);
+		pid = _DMA_PORT(dma_chan);
+		nid = _DMA_CHANNEL(dma_chan);
 		/* PPA Directpath/LitePath don't have DMA CH */
-		if (!(port_info->alloc_flags & DP_F_DIRECT))
+		if ((atomic_read(&dp_dma_chan_tbl[inst][cid][pid][nid].
+		    ref_cnt) == 0) && !(port_info->alloc_flags & DP_F_DIRECT))
 				cbm_data.dma_chnl_init = 1; /*to disable DMA */
 		if (cbm_dp_enable(owner, port_id, &cbm_data,
 				  CBM_PORT_F_DISABLE, port_info->alloc_flags)) {
diff --git a/drivers/net/ethernet/lantiq/datapath/datapath_proc_qos.c b/drivers/net/ethernet/lantiq/datapath/datapath_proc_qos.c
index 015a16120ec3..1f5b437a0994 100644
--- a/drivers/net/ethernet/lantiq/datapath/datapath_proc_qos.c
+++ b/drivers/net/ethernet/lantiq/datapath/datapath_proc_qos.c
@@ -716,7 +716,7 @@ char *dp_port_dma_tx_str(int cqm_deq_port, int flag)
 			if (!dp_port_info[inst][i].alloc_flags)
 				continue;
 			snprintf(dma_flag, sizeof(dma_flag), "CH%x",
-				_DMA_CHANNEL(dp_deq_port_tbl[inst][cqm_deq_port].dma_chan));
+				 dp_deq_port_tbl[inst][cqm_deq_port].dma_chan);
 			return dma_flag;
 		}
 	}
