From 51f1e3d584376cc52a5713f39598eb75edad160c Mon Sep 17 00:00:00 2001
From: agaraix <anath.bandux.garai@intel.com>
Date: Tue, 26 Mar 2019 11:28:21 +0530
Subject: [PATCH] UGW_SW-37200 : Fixed gretap device detection condition for
 EoGRE acceleration.

---
 net/ipv4/ip_gre.c  | 7 ++++++-
 net/ipv6/ip6_gre.c | 7 ++++++-
 2 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/net/ipv4/ip_gre.c b/net/ipv4/ip_gre.c
index 12b5298690f2..99af50ff6337 100644
--- a/net/ipv4/ip_gre.c
+++ b/net/ipv4/ip_gre.c
@@ -1190,7 +1190,12 @@ extern uint32_t (*ppa_is_ipv4_gretap_fn)(struct net_device *dev);
 
 static u32 ppa_is_ipv4_gretap(struct net_device *dev)
 {
-	return (dev && (dev->netdev_ops == (&gre_tap_netdev_ops)));
+	/* NOTE:
+	 * To include acelerated counters in gre_tap net_device stats,
+	 * gre_tap netdev_ops pointer (i.e., @gre_tap_netdev_ops) can be modified with a new one.
+	 * This is specifically to overload @ndo_get_stats64, but @ndo_init remains unchanged.
+	 */
+	return (dev && dev->netdev_ops && (dev->netdev_ops->ndo_init == gre_tap_netdev_ops.ndo_init));
 }
 #endif
 
diff --git a/net/ipv6/ip6_gre.c b/net/ipv6/ip6_gre.c
index 6584333a1b9f..c51aec0956ab 100644
--- a/net/ipv6/ip6_gre.c
+++ b/net/ipv6/ip6_gre.c
@@ -1574,7 +1574,12 @@ extern uint32_t (*ppa_is_ipv6_gretap_fn)(struct net_device *dev);
 
 static u32 ppa_is_ipv6_gretap(struct net_device *dev)
 {
-	return (dev && (dev->netdev_ops == (&ip6gre_tap_netdev_ops)));
+	/* NOTE:
+	 * To include acelerated counters in ip6gre_tap net_device stats,
+	 * ip6gre_tap netdev_ops pointer (i.e., @ip6gre_tap_netdev_ops) can be modified with a new one.
+	 * This is specifically to overload @ndo_get_stats64, but @ndo_init remains unchanged.
+	 */
+	return (dev && dev->netdev_ops && (dev->netdev_ops->ndo_init == ip6gre_tap_netdev_ops.ndo_init));
 }
 #endif
 
