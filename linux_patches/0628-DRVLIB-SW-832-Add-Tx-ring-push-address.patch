From 624b0461632a518a2f84d71e50a618e73a51eb9b Mon Sep 17 00:00:00 2001
From: kavitha3 <k.subramanian@intel.com>
Date: Mon, 6 May 2019 14:08:00 +0800
Subject: [PATCH] DRVLIB_SW-832: Add Tx ring push address

---
 drivers/net/ethernet/lantiq/cqm/prx300/cqm.c | 14 ++++++++++----
 include/net/lantiq_cbm_api.h                 |  6 ++++--
 2 files changed, 14 insertions(+), 6 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/cqm/prx300/cqm.c b/drivers/net/ethernet/lantiq/cqm/prx300/cqm.c
index 1c2249e480c8..3f787b795f1d 100644
--- a/drivers/net/ethernet/lantiq/cqm/prx300/cqm.c
+++ b/drivers/net/ethernet/lantiq/cqm/prx300/cqm.c
@@ -1831,9 +1831,11 @@ s32 cqm_cpu_port_get(struct cbm_cpu_port_data *data, u32 flags)
 	data->dq_tx_flush_info.deq_port = DMA_PORT_FOR_FLUSH;
 	data->dq_tx_flush_info.tx_ring_size = 1;
 	data->dq_tx_flush_info.tx_b_credit = 0;
-	data->dq_tx_flush_info.tx_ring_addr = (u32)(cqm_ctrl->txpush +
+	data->dq_tx_flush_info.txpush_addr_qos = (u32)(cqm_ctrl->txpush +
 				  (TXPUSH_CMD_RX_EGP_1 * DMA_PORT_FOR_FLUSH)) &
 				  0x7FFFFF;
+	data->dq_tx_flush_info.txpush_addr = (u32)(cqm_ctrl->txpush +
+				  (TXPUSH_CMD_RX_EGP_1 * DMA_PORT_FOR_FLUSH));
 	data->dq_tx_flush_info.tx_ring_offset = TXPUSH_CMD_RX_EGP_1;
 	data->dq_tx_flush_info.tx_pkt_credit =
 				dqm_port_info[DMA_PORT_FOR_FLUSH].dq_txpush_num;
@@ -1843,7 +1845,7 @@ s32 cqm_cpu_port_get(struct cbm_cpu_port_data *data, u32 flags)
 		data->dq_tx_flush_info.deq_port,
 		data->dq_tx_flush_info.tx_ring_size,
 		data->dq_tx_flush_info.tx_b_credit,
-		data->dq_tx_flush_info.tx_ring_addr,
+		data->dq_tx_flush_info.txpush_addr_qos,
 		data->dq_tx_flush_info.tx_ring_offset,
 		data->dq_tx_flush_info.tx_pkt_credit);
 
@@ -1857,9 +1859,11 @@ s32 cqm_cpu_port_get(struct cbm_cpu_port_data *data, u32 flags)
 		ptr->deq_port = i;
 		ptr->tx_ring_size = 1;
 		ptr->tx_b_credit = 0;
-		ptr->tx_ring_addr = (u32)(cqm_ctrl->txpush +
+		ptr->txpush_addr_qos = (u32)(cqm_ctrl->txpush +
 					  (TXPUSH_CMD_RX_EGP_1 * i)) &
 					  0x7FFFFF;
+		ptr->txpush_addr = (u32)(cqm_ctrl->txpush +
+					  (TXPUSH_CMD_RX_EGP_1 * i));
 		ptr->tx_ring_offset = TXPUSH_CMD_RX_EGP_1;
 		ptr->tx_pkt_credit = dqm_port_info[i].dq_txpush_num;
 	}
@@ -1918,8 +1922,10 @@ static void fill_dp_alloc_data(struct cbm_dp_alloc_data *data, int dp,
 	data->num_dma_chan = idx;
 	data->deq_port_num = (data->deq_port == DQM_PON_TYPE) ? 64 : idx;
 	/*Lower 22 bits*/
-	data->tx_ring_addr = (u32)(cqm_ctrl->txpush +
+	data->txpush_addr_qos = (u32)(cqm_ctrl->txpush +
 	(TXPUSH_CMD_RX_EGP_1 * port)) & 0x7FFFFF;
+	data->txpush_addr = (u32)(cqm_ctrl->txpush +
+	(TXPUSH_CMD_RX_EGP_1 * port));
 	data->tx_ring_offset = TXPUSH_CMD_RX_EGP_1;
 }
 
diff --git a/include/net/lantiq_cbm_api.h b/include/net/lantiq_cbm_api.h
index 34cb62136d71..1257ecd970e1 100644
--- a/include/net/lantiq_cbm_api.h
+++ b/include/net/lantiq_cbm_api.h
@@ -544,7 +544,8 @@ struct cbm_dp_alloc_data {
 	u32 dma_chan; /* its dma channel, -1 means no DMA channel used */
 	u32 tx_pkt_credit;  /*port tx packet credit */
 	u32 tx_b_credit;  /*port tx bytes credit */
-	u32 tx_ring_addr;  /*port ring address. should follow HW defintion*/
+	u32 txpush_addr_qos; /* QOS push address after shift or mask from QOS HW point of view */
+	u32 txpush_addr;  /*port ring address. should follow HW defintion*/
 	u32 tx_ring_size; /*ring size */
 	u32 tx_ring_offset;  /*next tx_ring_addr = current tx_ring_addr + tx_ring_offset */
 	void *tx_ring_addr_txpush; /* port ring physical base address/TXIN address  
@@ -575,7 +576,8 @@ struct cbm_tx_push {
 	s32 deq_port;
 	u32 tx_pkt_credit;  /*port tx packet credit */
 	u32 tx_b_credit;  /*port tx bytes credit */
-	u32 tx_ring_addr;  /*port ring address. should follow HW defintion*/
+	u32 txpush_addr_qos; /* QOS push address after shift or mask from QOS HW point of view */
+	u32 txpush_addr;  /*port ring address. should follow HW defintion*/
 	u32 tx_ring_size; /*ring size */
 	u32 tx_ring_offset;  /*next tx_ring_addr = current tx_ring_addr + tx_ring_offset */
 };
