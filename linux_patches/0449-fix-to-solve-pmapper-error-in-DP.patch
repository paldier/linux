From f8e0cc3ed6d53e670259e3eb358c9d3bb076ba7a Mon Sep 17 00:00:00 2001
From: Rekha Eswaran <rekha.eswaran@intel.com>
Date: Tue, 22 Jan 2019 16:03:16 +0800
Subject: [PATCH] fix to solve pmapper error in DP

---
 drivers/net/ethernet/lantiq/datapath/datapath_api.c | 21 ++++++++++++++++-----
 .../net/ethernet/lantiq/datapath/datapath_misc.c    | 20 ++++++++++----------
 2 files changed, 26 insertions(+), 15 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/datapath/datapath_api.c b/drivers/net/ethernet/lantiq/datapath/datapath_api.c
index 0cefa400c344..c78d3f9ab9c5 100644
--- a/drivers/net/ethernet/lantiq/datapath/datapath_api.c
+++ b/drivers/net/ethernet/lantiq/datapath/datapath_api.c
@@ -923,6 +923,7 @@ int32_t dp_register_subif_ext(int inst, struct module *owner,
 	int port_id, f_subif = -1;
 	struct pmac_port_info *port_info;
 	struct dp_subif_data tmp_data = {0};
+	dp_subif_t *subif_id_sync;
 	dp_get_netif_subifid_fn_t subifid_fn_t = NULL;
 
 	if (unlikely(!dp_init_ok)) {
@@ -999,12 +1000,21 @@ int32_t dp_register_subif_ext(int inst, struct module *owner,
 					  subif_id, data, flags);
 	if (!(flags & DP_F_SUBIF_LOGICAL))
 		subifid_fn_t = port_info->cb.get_subifid_fn;
-	dp_sync_subifid(dev, subif_name, subif_id, data, flags, &f_subif);
+	
+	subif_id_sync = kmalloc(sizeof(*subif_id_sync) * 2, GFP_KERNEL);
+	if (!subif_id_sync) {
+		PR_ERR("Failed to alloc %d bytes\n",
+		       sizeof(*subif_id_sync) * 2);
+		return DP_FAILURE;
+	}
+	memcpy(&subif_id_sync[0], subif_id, sizeof(dp_subif_t));
+	memcpy(&subif_id_sync[1], subif_id, sizeof(dp_subif_t));
+	dp_sync_subifid(dev, subif_name, subif_id_sync, data, flags, &f_subif);
 	DP_LIB_UNLOCK(&dp_lock);
 	if (!res)
-		dp_sync_subifid_priv(dev, subif_name, subif_id, data, flags,
-				     subifid_fn_t, &f_subif);
-
+		dp_sync_subifid_priv(dev, subif_name, subif_id_sync, data,
+				     flags, subifid_fn_t, &f_subif);
+	kfree(subif_id_sync);
 	return res;
 }
 EXPORT_SYMBOL(dp_register_subif_ext);
@@ -1198,8 +1208,9 @@ int32_t dp_get_netif_subifid_priv(struct net_device *netif, struct sk_buff *skb,
 					subif_flag[num] = PORT_SUBIF(inst, k, i,
 								subif_flag);
 					if (dp_port_info[inst][k].subif_info[i].
-						ctp_dev)
+						ctp_dev) {
 						subif->flag_pmapper = 1;
+					}
 					bport = PORT_SUBIF(inst, k, i, bp);
 					if (num &&
 					    (bport != dp_port_info[inst][k].
diff --git a/drivers/net/ethernet/lantiq/datapath/datapath_misc.c b/drivers/net/ethernet/lantiq/datapath/datapath_misc.c
index d0aa6efddad4..620b30180c33 100644
--- a/drivers/net/ethernet/lantiq/datapath/datapath_misc.c
+++ b/drivers/net/ethernet/lantiq/datapath/datapath_misc.c
@@ -1351,20 +1351,20 @@ int32_t dp_sync_subifid(struct net_device *dev, char *subif_name,
 	if (flags & DP_F_DEREGISTER) {
 
 		if (dp_get_netif_subifid_priv(dev, NULL, subif_data, NULL,
-					      subif_id, 0))
+					      &subif_id[0], 0))
 			*f_subif_up = 0;
 		else
 			*f_subif_up = 1;
 	} else {
 		if (dp_get_netif_subifid_priv(dev, NULL, subif_data,
-					      NULL, subif_id, 0)) {
+					      NULL, &subif_id[0], 0)) {
 			PR_ERR("DP subif synchronization fail\n");
 			return DP_FAILURE;
 		}
 		if (data->ctp_dev) {
 			if (dp_get_netif_subifid_priv(data->ctp_dev, NULL,
 						      subif_data, NULL,
-						      subif_id, 0))
+						      &subif_id[1], 0))
 				return DP_FAILURE;
 		}
 		*f_subif_up = 1;
@@ -1390,21 +1390,21 @@ int32_t dp_sync_subifid_priv(struct net_device *dev, char *subif_name,
 	/*check flag for register / deregister to update/del */
 	if (flags & DP_F_DEREGISTER) {
 		if (data->ctp_dev)
-			dp_del_subif(data->ctp_dev, subif_data, subif_id,
+			dp_del_subif(data->ctp_dev, subif_data, &subif_id[1],
 				     NULL, flags);
 
 		if (*f_subif_up == 0)
-			dp_del_subif(dev, subif_data, subif_id, subif_name,
+			dp_del_subif(dev, subif_data, &subif_id[0], subif_name,
 				     flags);
 		else if (*f_subif_up == 1)
-			dp_update_subif(dev, subif_data, subif_id, subif_name,
-					flags, subifid_fn);
+			dp_update_subif(dev, subif_data, &subif_id[0],
+					subif_name, flags, subifid_fn);
 	} else {
 		if (*f_subif_up == 1) {
-			dp_update_subif(dev, subif_data, subif_id, subif_name,
-					flags, subifid_fn);
+			dp_update_subif(dev, subif_data, &subif_id[0],
+					subif_name, flags, subifid_fn);
 		if (data->ctp_dev)
-			dp_update_subif(data->ctp_dev, subif_data, subif_id,
+			dp_update_subif(data->ctp_dev, subif_data, &subif_id[1],
 					NULL, flags, subifid_fn);
 		}
 	}
