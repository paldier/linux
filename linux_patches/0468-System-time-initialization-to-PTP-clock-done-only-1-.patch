From 225e492594261e75c0c2037e203d493ceb082813 Mon Sep 17 00:00:00 2001
From: thampan <joby.thampan@intel.com>
Date: Thu, 14 Feb 2019 18:03:18 +0800
Subject: [PATCH] System time initialization to PTP clock done only 1 time

---
 drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.c      | 2 ++
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h | 1 +
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c   | 1 +
 drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c    | 9 ++++++---
 4 files changed, 10 insertions(+), 3 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.c b/drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.c
old mode 100644
new mode 100755
index 48a7254db076..caa087222a3f
--- a/drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/mac_cfg.c
@@ -964,6 +964,8 @@ int mac_disable_ts(void *pdev)
 
 	xgmac_set_mac_int(pdev, XGMAC_TSTAMP_EVNT, 0);
 
+	pdata->systime_initialized = 0;
+
 #ifdef __KERNEL__
 	spin_unlock_bh(&pdata->mac_lock);
 #endif
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h
old mode 100644
new mode 100755
index 2b718af4e34f..f12371fc43e4
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_common.h
@@ -397,6 +397,7 @@ struct mac_prv_data {
 	u32 one_nsec_accuracy;
 	u32 cic;
 	u32 rec_id;
+	bool systime_initialized;
 	struct mac_fifo_entry ts_fifo[MAX_FIFO_ENTRY];
 
 #ifdef __KERNEL__
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c
old mode 100644
new mode 100755
index 9d0df45e63fd..26cf394536d4
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_main.c
@@ -170,6 +170,7 @@ void xgmac_init_pdata(struct mac_prv_data *pdata, int idx)
 	pdata->nsec			= 0;
 	pdata->ptp_clk			= PTP_CLK;
 	pdata->one_nsec_accuracy	= 1;
+	pdata->systime_initialized      = 0;
 #if defined(PC_UTILITY) || defined(CHIPTEST)
 	pdata->lmac_addr_base		= LEGACY_MAC_BASE;
 	pdata->ss_addr_base		= adap_priv_data.ss_addr_base;
diff --git a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
old mode 100644
new mode 100755
index cd26d23dfaf7..c1ff6c2d18a5
--- a/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
+++ b/drivers/net/ethernet/lantiq/switch-api/mac/xgmac_ptp.c
@@ -80,9 +80,12 @@ void xgmac_config_timer_reg(void *pdev)
 
 	hw_if->config_addend(pdev, pdata->def_addend);
 
-	/* initialize system time */
-	getnstimeofday(&now);
-	hw_if->init_systime(pdev, now.tv_sec, now.tv_nsec);
+	if (!pdata->systime_initialized) {
+		/* initialize system time */
+		getnstimeofday(&now);
+		hw_if->init_systime(pdev, now.tv_sec, now.tv_nsec);
+		pdata->systime_initialized = 1;
+	}
 }
 
 /* API to adjust the frequency of hardware clock.
