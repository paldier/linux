From e0f561b415543276ae92fe8040b6a1a18289ba10 Mon Sep 17 00:00:00 2001
From: Rekha Eswaran <rekha.eswaran@intel.com>
Date: Fri, 28 Jun 2019 17:04:47 +0800
Subject: [PATCH] UGW_SW-40557 - fix ATM de-registration crash

---
 drivers/net/datapath/dpm/datapath_instance.c | 3 ++-
 drivers/net/datapath/dpm/datapath_misc.c     | 4 ++++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/drivers/net/datapath/dpm/datapath_instance.c b/drivers/net/datapath/dpm/datapath_instance.c
index 66b2b4a3868c..5f0992c8fcee 100644
--- a/drivers/net/datapath/dpm/datapath_instance.c
+++ b/drivers/net/datapath/dpm/datapath_instance.c
@@ -362,10 +362,11 @@ int dp_inst_del_dev(struct net_device *dev, char *subif_name, int inst, int ep,
 
 			if (!dp_dev->count) { /*move to free list */
 				hlist_del(&dp_dev->hlist);
+				if (dev)
+					dp_ops_reset(dp_dev, dev);
 				/*do't really free now
 				 *in case network stack is holding the callback
 				 */
-				dp_ops_reset(dp_dev, dev);
 				hlist_add_head(&dp_dev->hlist,
 					       &dp_dev_list_free[idx]);
 			}
diff --git a/drivers/net/datapath/dpm/datapath_misc.c b/drivers/net/datapath/dpm/datapath_misc.c
index 6ace2ffc1230..0dfe5043a77e 100644
--- a/drivers/net/datapath/dpm/datapath_misc.c
+++ b/drivers/net/datapath/dpm/datapath_misc.c
@@ -1318,6 +1318,8 @@ int32_t dp_sync_subifid(struct net_device *dev, char *subif_name,
 	 * multiple DSL instances during dp_register_subif_ext
 	 */
 	port = get_dp_port_info(0, subif_id->port_id);
+	if (!port)
+		return DP_FAILURE;
 	if (port->alloc_flags & DP_F_FAST_DSL)
 		subif_data = (void *)subif_name;
 	/*check flag for register / deregister to update/del */
@@ -1360,6 +1362,8 @@ int32_t dp_sync_subifid_priv(struct net_device *dev, char *subif_name,
 	 * multiple DSL instances during dp_register_subif_ext
 	 */
 	port = get_dp_port_info(0, subif_id->port_id);
+	if (!port)
+		return DP_FAILURE;
 	if (port->alloc_flags & DP_F_FAST_DSL)
 		subif_data = (void *)subif_name;
 	/*check flag for register / deregister to update/del */
