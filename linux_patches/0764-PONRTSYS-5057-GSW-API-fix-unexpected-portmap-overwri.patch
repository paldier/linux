From ee463d30ecea19252b06d0128b35d3913cd81935 Mon Sep 17 00:00:00 2001
From: Xu Liang <liang.xu@intel.com>
Date: Wed, 28 Aug 2019 14:40:29 +0800
Subject: [PATCH] PONRTSYS-5057 - GSW API, fix unexpected portmap overwritte
 when clear hit status in multicast table

---
 drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c | 12 +++++++-----
 drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.h |  5 ++---
 drivers/net/ethernet/lantiq/switch-api/gsw_swmcast.c   |  4 ++--
 3 files changed, 11 insertions(+), 10 deletions(-)

diff --git a/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c b/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c
index 92fd706dcada..a4210e74a5d9 100644
--- a/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c
+++ b/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.c
@@ -11368,7 +11368,6 @@ GSW_return_t GSW_MulticastTableEntryRead(void *cdev,
 
 		if (parm->bInitial == 1) {
 			gswdev->msw_rinx = 0; /*Start from the index 0 */
-			gswdev->msw_rinx_31 = 0;
 			parm->bInitial = 0;
 		}
 
@@ -11381,13 +11380,16 @@ GSW_return_t GSW_MulticastTableEntryRead(void *cdev,
 		}
 
 		if (IS_VRSN_31(gswdev->gipver)) {
-			ret = gsw_get_swmcast_entry(cdev, parm, gswdev->msw_rinx_31);
-			gswdev->msw_rinx_31++;
+			ret = 0;
+			while (gswdev->msw_rinx < gswdev->mctblsize && !ret) {
+				ret = gsw_get_swmcast_entry(cdev, parm, gswdev->msw_rinx);
+				gswdev->msw_rinx++;
+			}
 
-			if (gswdev->msw_rinx_31 >= gswdev->mctblsize) {
+			if (gswdev->msw_rinx >= gswdev->mctblsize) {
 				memset(parm, 0, sizeof(GSW_multicastTableRead_t));
 				parm->bLast = 1;
-				gswdev->msw_rinx_31 = 0;
+				gswdev->msw_rinx = 0;
 			}
 
 			ret = GSW_statusOk;
diff --git a/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.h b/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.h
index f26cf54cf97c..6618585596fe 100644
--- a/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.h
+++ b/drivers/net/ethernet/lantiq/switch-api/gsw_flow_core.h
@@ -944,9 +944,8 @@ typedef struct {
 	ltq_bool_t hwinit;
 	u16 vlan_rd_index; 			/* read VLAN table index */
 	u16 mac_rd_index; 			/* read mac table index */
-	u8 mhw_rinx;
-	u8 msw_rinx;
-	u16 msw_rinx_31;
+	u16 mhw_rinx;
+	u16 msw_rinx;
 	u8 cport;
 	u8 gsw_dev;
 
diff --git a/drivers/net/ethernet/lantiq/switch-api/gsw_swmcast.c b/drivers/net/ethernet/lantiq/switch-api/gsw_swmcast.c
index 4bf859e5d880..2ee2c2e17301 100644
--- a/drivers/net/ethernet/lantiq/switch-api/gsw_swmcast.c
+++ b/drivers/net/ethernet/lantiq/switch-api/gsw_swmcast.c
@@ -246,8 +246,8 @@ int gsw_get_swmcast_entry(void *cdev, GSW_multicastTableRead_t *parm, u32 loc)
 			parm->hitstatus = LTQ_TRUE;
 
 			pcetable.val[gswdev->hitstatus_idx + 2] &=
-				gswdev->hitstatus_mask;
-			gsw_pce_table_key_write(cdev, &pcetable);
+				~gswdev->hitstatus_mask;
+			gsw_pce_table_write(cdev, &pcetable);
 		} else
 			parm->hitstatus = LTQ_FALSE;
 
