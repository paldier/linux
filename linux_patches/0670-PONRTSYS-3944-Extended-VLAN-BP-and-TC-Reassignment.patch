From a78c17ccaee0a72a8d1da4b59cdb64439f9794e9 Mon Sep 17 00:00:00 2001
From: thampan <joby.thampan@intel.com>
Date: Fri, 28 Jun 2019 15:53:00 +0800
Subject: [PATCH] PONRTSYS-3944: Extended VLAN BP and TC Reassignment

---
 .../datapath/dpm/gswip31/datapath_tc_asym_vlan.c   | 27 ++++++++++++++++++++++
 include/net/datapath_api_vlan.h                    |  9 ++++++++
 2 files changed, 36 insertions(+)

diff --git a/drivers/net/datapath/dpm/gswip31/datapath_tc_asym_vlan.c b/drivers/net/datapath/dpm/gswip31/datapath_tc_asym_vlan.c
index 2e0e41ac52ac..59e3f2f53308 100644
--- a/drivers/net/datapath/dpm/gswip31/datapath_tc_asym_vlan.c
+++ b/drivers/net/datapath/dpm/gswip31/datapath_tc_asym_vlan.c
@@ -594,12 +594,39 @@ static int ext_vlan_action_cfg(struct core_ops *ops,
 			       struct dp_act_vlan *act)
 {
 	int ret;
+	dp_subif_t subif;
 
 	DP_DEBUG(DP_DBG_FLAG_PAE, "act->act: 0x%02x\n", (unsigned int)act->act);
 
 	/* Copy DSCP table */
 	memcpy(pcfg->nDscp2PcpMap, act->dscp_pcp_map,
 	       sizeof(pcfg->nDscp2PcpMap));
+
+	DP_DEBUG(DP_DBG_FLAG_PAE, "act->ract.act: 0x%02x Bp_dev %p\n",
+		(unsigned int)act->ract.act, act->ract.bp_dev);
+
+	/* Reassign Bridge Port */
+	if ((act->ract.act & DP_BP_REASSIGN) && (act->ract.bp_dev)) {
+		
+		ret = dp_get_port_subitf_via_dev(act->ract.bp_dev, &subif);
+		if (ret == DP_FAILURE)
+			return 0;
+
+		DP_DEBUG(DP_DBG_FLAG_PAE, "New Bridge Port %d\n", subif.bport);
+
+		pcfg->bReassignBridgePort = 1;
+		pcfg->nNewBridgePortId = subif.bport;
+	}
+
+	/* Reassign traffic class */
+	if (act->ract.act & DP_TC_REASSIGN) {
+		
+		DP_DEBUG(DP_DBG_FLAG_PAE, "New TC %d\n", act->ract.new_tc);
+		
+		pcfg->bNewTrafficClassEnable = 1;
+		pcfg->nNewTrafficClass = act->ract.new_tc;
+	}
+	
 	/* forward without modification */
 	if ((act->act & DP_VLAN_ACT_FWD))
 		return 0;
diff --git a/include/net/datapath_api_vlan.h b/include/net/datapath_api_vlan.h
index 6b5937203fa0..d8b859886f78 100644
--- a/include/net/datapath_api_vlan.h
+++ b/include/net/datapath_api_vlan.h
@@ -46,6 +46,14 @@ struct dp_pattern_vlan {
 		   */
 };
 
+struct dp_act_reassign {
+#define DP_BP_REASSIGN     BIT(0)  /* Reassign to new bridge port */
+#define DP_TC_REASSIGN     BIT(1)  /* Set new traffic class */
+	int act;
+	int new_tc;             /* set new traffic class */
+	struct net_device *bp_dev;  /* BP network device where to reassign*/
+};
+
 struct dp_act_vlan {
 #define DP_VLAN_ACT_FWD    BIT(0)  /*forward packet without editing */
 #define DP_VLAN_ACT_DROP   BIT(1)  /*drop packet */
@@ -92,6 +100,7 @@ struct dp_act_vlan {
 				*  copy from recv pkt's outer tag(CP_FROM_OUTER)
 				*/
 	unsigned char dscp_pcp_map[64]; /* DSCP to P-bit mapping table */
+	struct dp_act_reassign ract; /* VLAN reassignment action */
 };
 
 #define DP_VLAN_DEF_RULE 1
